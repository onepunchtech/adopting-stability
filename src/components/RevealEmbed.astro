---
import revealCss from "reveal.js/dist/reveal.css?url";
import highlightCss from "reveal.js/plugin/highlight/monokai.css?url";

import themeBlack from "reveal.js/dist/theme/black.css?url";
import themeWhite from "reveal.js/dist/theme/white.css?url";
import themeNight from "reveal.js/dist/theme/night.css?url";
import themeSimple from "reveal.js/dist/theme/simple.css?url";
import themeSolarized from "reveal.js/dist/theme/solarized.css?url";
import themeSky from "reveal.js/dist/theme/sky.css?url";

type Props = {
  file: string;        // e.g. "motivation.md" or "talks/motivation.md"
  theme?: string;      // black | white | night | simple | solarized
  height?: string;     // e.g. "60vh"
  hash?: boolean;
};

const { file, theme = "sky", height = "70vh", hash = false } = Astro.props;

const themeMap: Record<string, string> = {
  black: themeBlack,
  white: themeWhite,
  night: themeNight,
  simple: themeSimple,
  solarized: themeSolarized,
  sky: themeSky,
};
const themeCss = themeMap[theme] ?? themeMap.black;

const slideFiles = import.meta.glob("../slides/**/*.md", {
  query: "?raw",
  import: "default",
  eager: true,
}) as Record<string, string>;

const matchPath = Object.keys(slideFiles).find((p) => p.endsWith(`/slides/${file}`));
if (!matchPath) throw new Error(`RevealEmbed: slide file not found: ${file}`);

const markdown = slideFiles[matchPath];

// give each embed a stable unique id
const id = `reveal-${Math.random().toString(36).slice(2)}`;
---

<link rel="stylesheet" href={revealCss} />
<link rel="stylesheet" href={themeCss} />
<link rel="stylesheet" href={highlightCss} />

<div
  id={id}
  data-reveal-embed
  data-hash={hash ? "true" : "false"}
  style={`height:${height}; margin: 1rem 0;`}
>
  <div class="reveal" style="height: 100%;">
    <div class="slides">
      <section data-markdown>
        <textarea data-template>{markdown}</textarea>
      </section>
    </div>
  </div>
</div>

<script type="module" define:vars={{ id }}>
  import Reveal from "https://cdn.jsdelivr.net/npm/reveal.js@5/dist/reveal.esm.js";
  import Markdown from "https://cdn.jsdelivr.net/npm/reveal.js@5/plugin/markdown/markdown.esm.js";
  import Highlight from "https://cdn.jsdelivr.net/npm/reveal.js@5/plugin/highlight/highlight.esm.js";
  import Notes from "https://cdn.jsdelivr.net/npm/reveal.js@5/plugin/notes/notes.esm.js";

  const root = document.getElementById(id);
  const revealEl = root?.querySelector(".reveal");
  if (!revealEl) {
    console.warn("RevealEmbed: .reveal element not found for", id);
  } else {
    // Focus = controls fullscreen target when multiple embeds exist
    revealEl.tabIndex = 0;
    root.addEventListener("pointerdown", () => revealEl.focus(), { passive: true });

    const deck = new Reveal(revealEl, {
      embedded: true,
      keyboardCondition: "focused",
      hash: root.dataset.hash === "true",
      plugins: [Markdown, Highlight, Notes],
    });

    deck.initialize();

    const ro = new ResizeObserver(() => deck.layout());
    ro.observe(root);
  }
</script>
