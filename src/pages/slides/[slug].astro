---
import RevealLayout from "../../layouts/RevealLayout.astro";

// Load all slide files as raw strings at build time
const slideFiles = import.meta.glob("../../slides/*.md", {
  query: "?raw",
  import: "default",
  eager: true,
});

// Turn a filepath into a slug
const toSlug = (path) =>
  path.split("/").pop().replace(/\.md$/, "");

// Cheap frontmatter stripper + parser (title/theme only)
function parseSlideFile(raw) {
  let title = "Slides";
  let theme = "black";
  let body = raw;

  if (raw.startsWith("---")) {
    const end = raw.indexOf("\n---", 3);
    if (end !== -1) {
      const fm = raw.slice(3, end).trim();
      body = raw.slice(end + "\n---".length).replace(/^\s*\n/, "");

      for (const line of fm.split("\n")) {
        const m = line.match(/^(\w+):\s*(.+)\s*$/);
        if (!m) continue;
        const [, k, v] = m;
        if (k === "title") title = v.replace(/^["']|["']$/g, "");
        if (k === "theme") theme = v.replace(/^["']|["']$/g, "");
      }
    }
  }
  return { title, theme, body };
}

export async function getStaticPaths() {
  return Object.keys(slideFiles).map((path) => ({
    params: { slug: toSlug(path) },
  }));
}

const slug = Astro.params.slug;
const matchPath = Object.keys(slideFiles).find((p) => toSlug(p) === slug);

if (!matchPath) throw new Error(`Slides not found: ${slug}`);

const raw = slideFiles[matchPath];
const { title, theme, body } = parseSlideFile(raw);
---

<RevealLayout title={title} theme={theme}>
  <section data-markdown>
    <textarea data-template>{body}</textarea>
  </section>
</RevealLayout>
